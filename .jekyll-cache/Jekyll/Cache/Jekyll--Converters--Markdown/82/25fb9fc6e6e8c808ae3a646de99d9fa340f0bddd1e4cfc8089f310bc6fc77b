I"ù<p>Locks are necessary constructs in multithreaded programs to gain exclusive access to shared resources. If you have written multithreaded code using POSIX API, then you may have also used the mutexes which are part of the pthread library.
There are many possible implementations of these mutex locks:</p>

<ol>
  <li>Test-and-set lock</li>
  <li>Ticket lock</li>
  <li>Mellor-Crummey and Scott(MCS) lock</li>
</ol>

<p>The MCS locking mechanism minimizes cache misses in multithreaded programs using FIFO ordering for lock acquisition.
Each thread which tries to acquire the lock and fails, enqueues itself in a linked list and waits on a thread local atomic. The lock holder releases the blocked thread by modifying the waiting threadâ€™s atomic.</p>

<p>The following image explains the FIFO ordering for incoming threads.
<img src="/assets/images/2023/mcs.png" alt="mcs lock" />
I have tried building a LIFO version of this lock. Each thread enqueues itself on top and waits on a local atomic. The lock holder upon release sets the top nodeâ€™s atomic thus releasing it.
<img src="/assets/images/2023/lifo.png" alt="lifo lock" /></p>

<p>Locking steps</p>
<ol>
  <li>Each thread gets a thread local node. Sets the turn state to false.</li>
  <li>Tries to get the current top of the list and performs compare and exchange to set itself to top.</li>
  <li>If the compare and exchange result shows that the previous top was NULL, then thread is the sole owner of the lock and can proceed.</li>
  <li>If the previous top was not NULL, then must wait on turn state to be set to true by current lock holder.</li>
</ol>

<p>Unlocking steps</p>
<ol>
  <li>Assuming self to be top of the linked list, do compare and exchange and set next node to top.</li>
  <li>If compare and exchange fails, then more nodes have arrived. Unlink self by setting previous nodeâ€™s next to selfâ€™s next. Set current top nodeâ€™s turn to true.</li>
  <li>If compare and exchange passes, then no new nodes have arrived. Set next nodeâ€™s turn to true.</li>
</ol>

:ET